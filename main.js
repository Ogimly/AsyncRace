(()=>{"use strict";(()=>{const t=class{getRequest(t,e){return n=this,i=void 0,r=function*(){try{const n=yield fetch(t,e);if(!n.ok)return{status:n.status,statusText:n.statusText};const i=n.headers,s=i.get("content-type");if(!s||!s.includes("application/json"))throw new Error("Response is not a JSON!");const r=yield n.json();return{ok:n.ok,status:n.status,data:r,headers:i}}catch(t){}},new((s=void 0)||(s=Promise))((function(t,e){function a(t){try{c(r.next(t))}catch(t){e(t)}}function o(t){try{c(r.throw(t))}catch(t){e(t)}}function c(e){var n;e.done?t(e.value):(n=e.value,n instanceof s?n:new s((function(t){t(n)}))).then(a,o)}c((r=r.apply(n,i||[])).next())}));var n,i,s,r}};class e{constructor(t,e){this.node=document.createElement("button"),this.node.className=`button button_${t}`,this.node.textContent=e}render(){return this.node}}const n=e,i=class{constructor(t){document.body.classList.add("lock"),this._container=document.createElement("div"),this._container.className="modal",document.body.append(this._container),this._window=document.createElement("div"),this._window.className="modal__window",this._container.append(this._window);const n=document.createElement("p");n.className="modal__text",n.textContent=t,this._window.append(n),this._button=new e("modal","X").render(),this._window.append(this._button),this._button.addEventListener("click",this.close.bind(this)),document.addEventListener("keydown",(t=>{"Escape"===t.key&&this.close()}))}close(){this._container.remove(),document.body.classList.remove("lock")}};class s extends i{}const r=t=>{new s(`[Alert] ${t}`)};var a,o,c,d,h,l,u;!function(t){t.garage="garage",t.winners="winners",t.help="help"}(a||(a={})),function(t){t.noServer="Server not found! Please check that the server is running",t.noData="Data not received",t.noGetCars="Failed to get cars from server!",t.noAddCar="Failed to add car to server!",t.noCarsOnPage="No cars to run the race! Add cars before starting",t.noStartEngine="Failed to start car engine!",t.noStopEngine="Failed to stop car engine!",t.noStartDrive="Failed to switches engine to drive mode!",t.noCarsFinished="Oops... Not a single car finished",t.noGetWinners="Failed to get winners from server!"}(o||(o={})),function(t){t[t.ok=200]="ok",t[t.created=201]="created",t[t.badRequest=400]="badRequest",t[t.notFound=404]="notFound",t[t.tooManyRequests=429]="tooManyRequests",t[t.internalServerError=500]="internalServerError"}(c||(c={})),function(t){t.garage="garage",t.engine="engine",t.winners="winners"}(d||(d={})),function(t){t.get="GET",t.post="POST",t.put="PUT",t.patch="PATCH",t.delete="DELETE"}(h||(h={})),function(t){t.id="id",t.wins="wins",t.time="time"}(l||(l={})),function(t){t.asc="ASC",t.desc="DESC"}(u||(u={}));const _="http://localhost:3000",m=a.help,p=l.wins,g=u.desc;let w=[];var v,C,b,f;v=void 0,C=void 0,f=function*(){try{const e=yield(new t).getRequest("./assets/carsModel.json",{});(null==e?void 0:e.ok)&&(w=Object.entries(null==e?void 0:e.data))}catch(t){r(t)}},new((b=void 0)||(b=Promise))((function(t,e){function n(t){try{s(f.next(t))}catch(t){e(t)}}function i(t){try{s(f.throw(t))}catch(t){e(t)}}function s(e){var s;e.done?t(e.value):(s=e.value,s instanceof b?s:new b((function(t){t(s)}))).then(n,i)}s((f=f.apply(v,C||[])).next())}));const y=t=>{const e=t.getBoundingClientRect();return{width:e.width,height:e.height}},E=t=>{const e=t.getBoundingClientRect();return{x:e.left+e.width/2,y:e.top+e.height/2}},S=()=>{const t=Math.floor(Math.random()*w.length),e=w[t][0],n=w[t][1];return`${e} ${n[Math.floor(Math.random()*n.length)]}`},P=()=>{let t="#";for(let e=0;e<6;e++)t+="0123456789ABCDEF"[Math.floor(16*Math.random())];return t},N=()=>({id:0,name:S(),color:P()}),x=t=>`<svg class="car-svg" fill=${t}>\n  <use xlink:href="./assets/sprite.svg#car"></use>\n</svg>`;const $=class{constructor(){this._endpoints=new Map([[d.garage,`${_}/${d.garage}`],[d.engine,`${_}/${d.engine}`],[d.winners,`${_}/${d.winners}`]]),this._request=new t}getRequest(t,e){return function(t,e,n,i){return new(n||(n=Promise))((function(s,r){function a(t){try{c(i.next(t))}catch(t){r(t)}}function o(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,o)}c((i=i.apply(t,e||[])).next())}))}(this,void 0,void 0,(function*(){try{const n=yield this._request.getRequest(t,e);if(!n)throw new Error(o.noServer);if(n.ok||n.status===c.notFound||n.status===c.tooManyRequests||n.status===c.internalServerError)return n;throw new Error(`${o.noData} (${n.status}) ${n.statusText}`)}catch(t){r(t)}}))}getCars(t,e=7){const n=`${this._endpoints.get(d.garage)}?_page=${t}&_limit=${e}`,i={method:h.get};return this.getRequest(n,i)}getCar(t){const e=`${this._endpoints.get(d.garage)}/${t}`,n={method:h.get};return this.getRequest(e,n)}createCar(t){const e=`${this._endpoints.get(d.garage)}`,n={method:h.post,body:JSON.stringify(t),headers:{"Content-Type":"application/json"}};return this.getRequest(e,n)}deleteCar(t){const e=`${this._endpoints.get(d.garage)}/${t}`,n={method:h.delete};return this.getRequest(e,n)}updateCar(t,e){const n=`${this._endpoints.get(d.garage)}/${t}`,i={method:h.put,body:JSON.stringify(e),headers:{"Content-Type":"application/json"}};return this.getRequest(n,i)}startEngine(t){const e=`${this._endpoints.get(d.engine)}?id=${t}&status=started`,n={method:h.patch};return this.getRequest(e,n)}stopEngine(t){const e=`${this._endpoints.get(d.engine)}?id=${t}&status=stopped`,n={method:h.patch};return this.getRequest(e,n)}switchDriveMode(t){const e=`${this._endpoints.get(d.engine)}?id=${t}&status=drive`,n={method:h.patch};return this.getRequest(e,n)}getWinners(t,e=p,n=g,i=10){const s=`${this._endpoints.get(d.winners)}?_page=${t}&_limit=${i}&_sort=${e}&_order=${n}`,r={method:h.get};return this.getRequest(s,r)}getWinner(t){const e=`${this._endpoints.get(d.winners)}/${t}`,n={method:h.get};return this.getRequest(e,n)}createWinner(t){const e=`${this._endpoints.get(d.winners)}`,n={method:h.post,body:JSON.stringify(t),headers:{"Content-Type":"application/json"}};return this.getRequest(e,n)}deleteWinner(t){const e=`${this._endpoints.get(d.winners)}/${t}`,n={method:h.delete};return this.getRequest(e,n)}updateWinner(t,e){const n=`${this._endpoints.get(d.winners)}/${t}`,i={method:h.put,body:JSON.stringify(e),headers:{"Content-Type":"application/json"}};return this.getRequest(n,i)}};const A=class{constructor(t,e){this._state=t,this._controller=e}topCarPage(){this.moveCarPage(1)}prevCarPage(){this.moveCarPage(Math.max(1,this._state.getCarsPage()-1))}nextCarPage(){this.moveCarPage(this._state.getCarsPage()+1)}bottomCarPage(){this.moveCarPage(Math.ceil(this._state.getCarsNumber()/7))}moveCarPage(t){return function(t,e,n,i){return new(n||(n=Promise))((function(s,r){function a(t){try{c(i.next(t))}catch(t){r(t)}}function o(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,o)}c((i=i.apply(t,e||[])).next())}))}(this,void 0,void 0,(function*(){try{this._state.setCarsPage(t),yield this._controller.getCars(),this._state.updView()}catch(t){r(t)}}))}};var k=function(t,e,n,i){return new(n||(n=Promise))((function(s,r){function a(t){try{c(i.next(t))}catch(t){r(t)}}function o(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,o)}c((i=i.apply(t,e||[])).next())}))};const D=class{constructor(){this.listeners=[]}add(t){this.listeners.push(t)}remove(t){this.listeners=this.listeners.filter((e=>e!==t))}emit(t){this.listeners.forEach((e=>e(t)))}},W=class{constructor(t){this._container=document.createElement("div"),this._container.className=t}renderTitle(t){const e=document.createElement("h2");e.className="main__title",e.textContent=t,this._container.append(e)}destroy(){this._container.innerHTML=""}},T=class extends i{constructor(t,n,i){super(t);const{name:s,color:r}=n;let a=document.createElement("label");a.className="modal__label",a.htmlFor="name",a.textContent="Input Car Name:",this._window.append(a),this._inputName=document.createElement("input"),this._inputName.className="modal__input_name",this._inputName.id="name",this._inputName.value=s,this._inputName.placeholder="Car name...",this._window.append(this._inputName),a=document.createElement("label"),a.className="modal__label",a.htmlFor="color",a.textContent="Input Car Color:",this._window.append(a),this._inputColor=document.createElement("input"),this._inputColor.className="modal__input_color",this._inputColor.type="color",this._inputColor.id="color",this._inputColor.value=r,this._window.append(this._inputColor);const o=document.createElement("div");o.className="modal__buttons",this._window.append(o),this._ok=new e("control","Ok").render(),o.append(this._ok),this._ok.addEventListener("click",(()=>{this.close();const t={id:n.id,name:this._inputName.value,color:this._inputColor.value};i(t)}));const c=new e("control","Cancel").render();o.append(c),c.addEventListener("click",this.close.bind(this))}};var R=function(t,e,n,i){return new(n||(n=Promise))((function(s,r){function a(t){try{c(i.next(t))}catch(t){r(t)}}function o(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,o)}c((i=i.apply(t,e||[])).next())}))};var L=function(t,e,n,i){return new(n||(n=Promise))((function(s,r){function a(t){try{c(i.next(t))}catch(t){r(t)}}function o(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,o)}c((i=i.apply(t,e||[])).next())}))};class q{constructor(t,e,i){this._garageView=t,this._garageController=e,this._raceController=i,this._btnAddCar=new n("control","Add new car"),this._btnAddCars=new n("control","Add 100 cars"),this._btnRace=new n("control","Start race"),this._btnReset=new n("control","Reset"),this._container=document.createElement("div"),this._container.className="pagination",this._container.append(this._btnAddCar.render()),this._container.append(this._btnAddCars.render()),this._container.append(this._btnRace.render()),this._container.append(this._btnReset.render()),this._btnAddCar.node.addEventListener("click",(()=>{new T("Add New Car",N(),(t=>L(this,void 0,void 0,(function*(){yield this._garageController.addCar(t)}))))})),this._btnAddCars.node.addEventListener("click",(()=>L(this,void 0,void 0,(function*(){yield this._garageController.addCars()})))),this._btnRace.node.addEventListener("click",(()=>L(this,void 0,void 0,(function*(){this._garageView.resetAllAnimations(),this._garageView.switchDisabledAllControls(!0),yield this._raceController.StartRace(),this._garageView.switchDisabledAllControls(!1)})))),this._btnReset.node.addEventListener("click",(()=>L(this,void 0,void 0,(function*(){yield this._raceController.ResetRace(),this._btnRace.node.disabled=!1}))))}render(){return this._container}switchDisabledControls(t){this._btnAddCar.node.disabled=t,this._btnAddCars.node.disabled=t,this._btnRace.node.disabled=t,this._btnReset.node.disabled=t,t||(this._btnRace.node.disabled=!0)}switchDisabledStart(t){this._btnRace.node.disabled=t}}const M=class{constructor(){this._btnTop=new n("pagination","<< Top"),this._btnPrev=new n("pagination","< Previous"),this._btnNext=new n("pagination","Next >"),this._btnBottom=new n("pagination","Bottom >>"),this._container=document.createElement("div"),this._container.className="pagination",this._container.append(this._btnTop.render()),this._container.append(this._btnPrev.render()),this._container.append(this._btnNext.render()),this._container.append(this._btnBottom.render())}checkButtons(t,e){t=Math.max(1,t),1===e?(this._btnPrev.node.disabled=!0,this._btnTop.node.disabled=!0):(this._btnPrev.node.disabled=!1,this._btnTop.node.disabled=!1),e===t?(this._btnNext.node.disabled=!0,this._btnBottom.node.disabled=!0):(this._btnNext.node.disabled=!1,this._btnBottom.node.disabled=!1)}},V=class extends M{constructor(t,e,n){super(),this._state=t,this._garageController=e,this._garageView=n,this._paginationController=new A(this._state,this._garageController),this._btnTop.node.addEventListener("click",(()=>{this._paginationController.topCarPage()})),this._btnPrev.node.addEventListener("click",(()=>{this._paginationController.prevCarPage()})),this._btnNext.node.addEventListener("click",(()=>{this._paginationController.nextCarPage()})),this._btnBottom.node.addEventListener("click",(()=>{this._paginationController.bottomCarPage()}))}render(){const t=this._state.getCarsPage(),e=Math.ceil(this._state.getCarsNumber()/7);return this.checkButtons(e,t),this._garageView.switchDisabledStart(!1),this._container}switchDisabledControls(t){if(this._btnTop.node.disabled=t,this._btnPrev.node.disabled=t,this._btnNext.node.disabled=t,this._btnBottom.node.disabled=t,!t){const t=this._state.getCarsPage(),e=Math.ceil(this._state.getCarsNumber()/7);this.checkButtons(e,t)}}};var B=function(t,e,n,i){return new(n||(n=Promise))((function(s,r){function a(t){try{c(i.next(t))}catch(t){r(t)}}function o(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,o)}c((i=i.apply(t,e||[])).next())}))};var F=function(t,e,n,i){return new(n||(n=Promise))((function(s,r){function a(t){try{c(i.next(t))}catch(t){r(t)}}function o(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,o)}c((i=i.apply(t,e||[])).next())}))};const U=class extends W{constructor(t,e,n){super("main_garage"),this._state=t,this._controller=e,this._winnersController=n,this._raceController=new class{constructor(t,e,n,i=new $){this._state=t,this._controller=e,this._winnersController=n,this._racerService=i}startCar(t){return B(this,void 0,void 0,(function*(){try{const e=Date.now(),n=yield this._racerService.startEngine(t);if(!(null==n?void 0:n.data))throw new Error(`${o.noStartEngine} [car id=${t}] ${o.noData}`);const{velocity:i,distance:s}=n.data,r=Math.round(s/i),a=this._state.getTrack(t);this._state.startAnimation(t,r,a,e)}catch(t){r(t)}}))}driveCar(t){return B(this,void 0,void 0,(function*(){try{const e=yield this._racerService.switchDriveMode(t);if((null==e?void 0:e.status)===c.internalServerError)return this._state.getAnimation(t).started&&(this._state.setResultAnimation(t,"engine breakdown"),this._state.stopAnimation(t)),{id:t,result:0};if((null==e?void 0:e.status)!==c.ok)throw new Error(`${o.noStartDrive} [car id=${t}] (${null==e?void 0:e.status}) ${null==e?void 0:e.statusText}`);if(this._state.getAnimation(t).started){const e=(Date.now()-this._state.getAnimation(t).startTime)/1e3;return this._state.setResultAnimation(t,`time: ${e}`),{id:t,result:e}}}catch(t){r(t)}}))}driveTest(t){return B(this,void 0,void 0,(function*(){return new Promise(((e,n)=>{this._racerService.switchDriveMode(t).then((i=>{if((null==i?void 0:i.status)===c.internalServerError)this._state.getAnimation(t).started&&(this._state.setResultAnimation(t,"engine breakdown"),this._state.stopAnimation(t)),n(!1);else if((null==i?void 0:i.status)!==c.ok&&n(),this._state.getAnimation(t).started){const n=(Date.now()-this._state.getAnimation(t).startTime)/1e3;this._state.setResultAnimation(t,`time: ${n}`),e({id:t,result:n})}})).catch((t=>{throw new Error(t)}))}))}))}stopCar(t){return B(this,void 0,void 0,(function*(){try{yield this._racerService.stopEngine(t),this._state.setResultAnimation(t,""),this._state.stopAnimation(t)}catch(t){r(t)}}))}StartRace(){return B(this,void 0,void 0,(function*(){try{const t=this._state.getCars();if(0===t.length)throw new Error(o.noCarsOnPage);const e=t.map((t=>B(this,void 0,void 0,(function*(){return yield this.startCar(t.id),this.driveTest(t.id)})))),n=yield Promise.any(e).catch((()=>{throw new Error(o.noCarsFinished)}));if(!n)throw new Error(o.noCarsFinished);const{id:i,result:s}=n;this._state.setResultAnimation(i,`WINNER! time: ${s}`),this.setWinner(i,s),yield Promise.allSettled(e)}catch(t){t&&r(t)}}))}setWinner(t,e){return B(this,void 0,void 0,(function*(){const n=yield this._racerService.getWinner(t);if((null==n?void 0:n.status)===c.notFound)yield this._racerService.createWinner({id:t,wins:1,time:e}),yield this._winnersController.getWinners();else if((null==n?void 0:n.status)===c.ok){const{wins:i,time:s}=n.data;e=Math.min(e,s),yield this._racerService.updateWinner(t,{wins:i+1,time:e}),yield this._winnersController.getWinners()}}))}ResetRace(){return B(this,void 0,void 0,(function*(){try{const t=this._state.getCars().map((t=>this.stopCar(t.id)));yield Promise.all(t),this._controller.getCars()}catch(t){r(t)}}))}}(this._state,this._controller,this._winnersController),this._controllersView=new q(this,this._controller,this._raceController),this._paginationView=new V(this._state,this._controller,this),this._state.onChange.add((()=>{this.render()})),this._state.onStartAnimation.add((t=>{this.startAnimation(t)})),this._state.onStopAnimation.add((t=>{this.stopAnimation(t)})),this._state.onSetResultAnimation.add((t=>{this.renderResultCar(t)})),(()=>{F(this,void 0,void 0,(function*(){yield this._controller.getCars()}))})()}getPage(){return this._container}render(){this.destroy(),this.renderTitle(`Garage (${this._state.getCarsNumber()}) - page #${this._state.getCarsPage()}`),this.renderGarage(this._state.getCars())}renderGarage(t){this._container.append(this._controllersView.render()),this._container.append(this.renderCars(t)),this._container.append(this._paginationView.render())}renderCars(t){const e=document.createElement("div");return e.className="garage",this._container.append(e),this._state.clearTracks(),t&&t.forEach((t=>{const n=document.createElement("div");n.className="garage__line-wrapper",n.append(this.renderLine(t)),e.append(n)})),e}renderLine(t){const e=document.createElement("div");e.className="garage__line";const i=new class{constructor(t,e,i,s,r,a){this._car=t,this._state=e,this._garageView=i,this._garageController=s,this._raceController=r,this._winnersController=a,this._btnUpdCar=new n("round","U"),this._btnDelCar=new n("round","X"),this._btnStart=new n("round","A"),this._btnStop=new n("round","B"),this._container=document.createElement("div"),this._container.className="garage__controls",this._btnStop.node.disabled=!0,this._container.append(this._btnUpdCar.render()),this._container.append(this._btnStart.render()),this._container.append(this._btnDelCar.render()),this._container.append(this._btnStop.render()),this._btnUpdCar.node.addEventListener("click",(()=>{new T("Update Car",this._car,(t=>R(this,void 0,void 0,(function*(){yield this._garageController.updateCar(t),yield this._winnersController.getWinners()}))))})),this._btnDelCar.node.addEventListener("click",(()=>R(this,void 0,void 0,(function*(){this._btnDelCar.node.disabled=!0,yield this._garageController.delCar(this._car),yield this._winnersController.getWinners(),this._btnDelCar.node.disabled=!1})))),this._btnStart.node.addEventListener("click",(()=>R(this,void 0,void 0,(function*(){const t=this._car.id;this._state.getAnimation(t).started&&this._garageView.stopAnimation(t),this._garageView.resetAnimation(t),this._btnStart.node.disabled=!0,this._btnUpdCar.node.disabled=!0,this._btnDelCar.node.disabled=!0,this._garageView.switchDisabledControls(!0),yield this._raceController.startCar(t),this._btnStop.node.disabled=!1,yield this._raceController.driveCar(t),this._garageView.switchDisabledControls(!1),this._garageView.switchDisabledStart(!1)})))),this._btnStop.node.addEventListener("click",(()=>R(this,void 0,void 0,(function*(){yield this._raceController.stopCar(this._car.id),this._garageView.resetAnimation(this._car.id),this._btnStart.node.disabled=!1,this._btnUpdCar.node.disabled=!1,this._btnDelCar.node.disabled=!1,this._btnStop.node.disabled=!0,this._garageView.switchDisabledControls(!1),this._garageView.switchDisabledStart(!1)}))))}render(){return this._container}switchDisabledControls(t){t?(this._btnUpdCar.node.disabled=t,this._btnDelCar.node.disabled=t,this._btnStart.node.disabled=t,this._btnStop.node.disabled=t):this._btnStop.node.disabled=t}}(t,this._state,this,this._controller,this._raceController,this._winnersController);e.append(i.render());const s=document.createElement("p");s.className="garage__car-name",s.textContent=`${t.name} (${t.id})`,e.append(s);const r=this.renderCar(t);e.append(r);const a=this.renderFinish();return e.append(a),this._state.addTrack(t.id,{car:r,finish:a,text:s},i),e}renderCar(t){const e=document.createElement("div");return e.className="garage__car",e.innerHTML=x(t.color),e.addEventListener("click",(()=>{new T("Update Car",t,(t=>F(this,void 0,void 0,(function*(){yield this._controller.updateCar(t),yield this._winnersController.getWinners()}))))})),e}renderFinish(){const t=document.createElement("div");return t.className="garage__finish",t}startAnimation(t){const{time:e,track:n}=this._state.getAnimation(t),{car:i,finish:s}=n,r=y(i).width+y(s).width;let a=function(t,e){const n=E(t),i=E(e);return Math.sqrt(Math.pow(n.x-i.x,2)+Math.pow(n.y-i.y,2))}(i,s)-r/2;const o=r*e/a;a+=r;const c=a/(e+o);let d=0;const h=e=>{0===d&&(d=e);const n=Math.round((e-d)*c);i.style.transform="translate("+Math.min(a,n)+"px, -50%)",n<a&&this._state.setIDAnimation(t,window.requestAnimationFrame(h))};this._state.setIDAnimation(t,window.requestAnimationFrame(h))}stopAnimation(t){window.cancelAnimationFrame(this._state.getAnimation(t).requestID)}resetAnimation(t){const e=this._state.getCar(t);e&&(this._state.getTrack(t).car.style.transform="translate(0px, -50%)",this._state.getTrack(t).text.textContent=`${e.name} (${e.id})`)}resetAllAnimations(){this._state.getCars().forEach((t=>{this.stopAnimation(t.id),this.resetAnimation(t.id)}))}renderResultCar(t){const e=this._state.getAnimation(t).result,n=this._state.getCar(t);n&&(this._state.getTrack(t).text.textContent=""===e?`${n.name} (${n.id})`:`${n.name} (${n.id}) - ${e}`)}switchDisabledControls(t){this._controllersView.switchDisabledControls(t),this._paginationView.switchDisabledControls(t)}switchDisabledStart(t){this._controllersView.switchDisabledStart(t)}switchDisabledAllControls(t){this._controllersView.switchDisabledControls(t),this._paginationView.switchDisabledControls(t),this._state.getTrackControls().forEach((e=>e.switchDisabledControls(t)))}},O=class extends W{constructor(){super("main_help")}getPage(){this.destroy(),this.renderTitle("Welcome to Async Race! Buttons mean:");const t=document.createElement("div");return t.className="help__inner",this._container.append(t),t.append(this.renderDescribe("round-no-hover","U","Update the car (also you can click on the car image)")),t.append(this.renderDescribe("round-no-hover","X","Delete the car")),t.append(this.renderDescribe("round-no-hover","A","Start engine of the car")),t.append(this.renderDescribe("round-no-hover","B","Stop engine of the car and return to start")),t.append(this.renderDescribe("round-no-hover","▲","Ascending sort")),t.append(this.renderDescribe("round-no-hover","▼","Descending sort")),t.append(this.renderDescribe("round-no-hover","?","Show this page")),t.append(this.renderDescribe("link-no-hover","Garage","Go to the Garage page")),t.append(this.renderDescribe("link-no-hover","Winners","Go to the Winners page")),this._container}renderDescribe(t,e,i){const s=document.createElement("div");s.className="help__description",s.append(new n(t,e).render());const r=document.createElement("span");return r.textContent=` - ${i}`,s.append(r),s}};var G=function(t,e,n,i){return new(n||(n=Promise))((function(s,r){function a(t){try{c(i.next(t))}catch(t){r(t)}}function o(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,o)}c((i=i.apply(t,e||[])).next())}))};const I=class extends M{constructor(t,e){super(),this._state=t,this._winnersController=e,this._paginationController=new class{constructor(t,e){this._state=t,this._controller=e}topWinnersPage(){this.moveWinnersPage(1)}prevWinnersPage(){this.moveWinnersPage(this._state.getWinnersPage()-1)}nextWinnersPage(){this.moveWinnersPage(this._state.getWinnersPage()+1)}bottomWinnersPage(){this.moveWinnersPage(Math.ceil(this._state.getWinnersNumber()/10))}moveWinnersPage(t){return function(t,e,n,i){return new(n||(n=Promise))((function(s,r){function a(t){try{c(i.next(t))}catch(t){r(t)}}function o(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,o)}c((i=i.apply(t,e||[])).next())}))}(this,void 0,void 0,(function*(){try{this._state.setWinnersPage(t),yield this._controller.getWinners(),this._state.updView()}catch(t){r(t)}}))}}(this._state,this._winnersController),this._btnTop.node.addEventListener("click",(()=>{this._paginationController.topWinnersPage()})),this._btnPrev.node.addEventListener("click",(()=>{this._paginationController.prevWinnersPage()})),this._btnNext.node.addEventListener("click",(()=>{this._paginationController.nextWinnersPage()})),this._btnBottom.node.addEventListener("click",(()=>{this._paginationController.bottomWinnersPage()}))}render(){const t=this._state.getWinnersPage(),e=Math.ceil(this._state.getWinnersNumber()/10);return this.checkButtons(e,t),this._container}};var j=function(t,e,n,i){return new(n||(n=Promise))((function(s,r){function a(t){try{c(i.next(t))}catch(t){r(t)}}function o(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,o)}c((i=i.apply(t,e||[])).next())}))};const H=class extends W{constructor(t,e){super("main_winners"),this._state=t,this._controller=e,this._btnWinsUp=new n("round-small","▲"),this._btnWinsDown=new n("round-small","▼"),this._btnTimeUp=new n("round-small","▲"),this._btnTimeDown=new n("round-small","▼"),this._paginationView=new I(this._state,this._controller),this.setActiveButtons(),this._btnWinsUp.node.addEventListener("click",(()=>{this._state.setSortName(l.wins),this._state.setSortOrder(u.asc),this.changeSorting()})),this._btnWinsDown.node.addEventListener("click",(()=>{this._state.setSortName(l.wins),this._state.setSortOrder(u.desc),this.changeSorting()})),this._btnTimeUp.node.addEventListener("click",(()=>{this._state.setSortName(l.time),this._state.setSortOrder(u.asc),this.changeSorting()})),this._btnTimeDown.node.addEventListener("click",(()=>{this._state.setSortName(l.time),this._state.setSortOrder(u.desc),this.changeSorting()})),this._state.onChange.add((()=>{this.render()})),(()=>{j(this,void 0,void 0,(function*(){yield this._controller.getWinners()}))})()}getPage(){return this._container}render(){this.destroy(),this.renderTitle(`Winners (${this._state.getWinnersNumber()}) - page #${this._state.getWinnersPage()}`),this.renderWinners(this._state.getWinners())}renderWinners(t){this.renderTable(t),this._container.append(this._paginationView.render())}renderTable(t){return j(this,void 0,void 0,(function*(){const e=document.createElement("div");e.className="winners",this._container.append(e);const n=document.createElement("table");e.append(n),n.append(this.renderTableTitle());const i=document.createElement("tbody");n.append(i);const s=10*(this._state.getWinnersPage()-1);if(t){const e=t.map((t=>this._controller.getCar(t.id))),n=yield Promise.all(e);t.forEach(((t,e)=>{const r=n.find((e=>e.id===t.id));r&&i.append(this.renderLine(t,e+s,r))}))}}))}renderTableTitle(){const t=document.createElement("thead"),e=document.createElement("tr");t.append(e);let n=document.createElement("th");return n.textContent="№",e.append(n),n=document.createElement("th"),n.textContent="Image of the car",e.append(n),n=document.createElement("th"),n.textContent="Name of the car",e.append(n),n=document.createElement("th"),n.textContent="Wins number ",n.append(this._btnWinsUp.render()),n.append(this._btnWinsDown.render()),e.append(n),n=document.createElement("th"),n.textContent="Best time in seconds ",n.append(this._btnTimeUp.render()),n.append(this._btnTimeDown.render()),e.append(n),t}renderLine(t,e,{name:n,color:i}){const s=document.createElement("tr");let r=document.createElement("th");return r.textContent=`${e+1}`,s.append(r),r=document.createElement("th"),r.innerHTML=x(i),s.append(r),r=document.createElement("th"),r.textContent=n,s.append(r),r=document.createElement("th"),r.textContent=`${t.wins}`,s.append(r),r=document.createElement("th"),r.textContent=`${t.time}`,s.append(r),s}setActiveButtons(){const t=this._state.getSortName(),e=this._state.getSortOrder();this._btnWinsDown.node.classList.remove("active"),this._btnWinsUp.node.classList.remove("active"),this._btnTimeDown.node.classList.remove("active"),this._btnTimeUp.node.classList.remove("active"),t===l.wins?e===u.desc?this._btnWinsDown.node.classList.add("active"):this._btnWinsUp.node.classList.add("active"):e===u.desc?this._btnTimeDown.node.classList.add("active"):this._btnTimeUp.node.classList.add("active")}changeSorting(){return j(this,void 0,void 0,(function*(){this.setActiveButtons(),yield this._controller.getWinners(),this.render()}))}};class J{constructor(){this._header=new class{constructor(){this.container=document.createElement("header"),this.container.className="header-app"}render(){const t=document.createElement("div");t.className="header__inner",this.container.append(t);let e=document.createElement("a");e.className="header__link",e.href="#garage",e.textContent="",t.append(e);let i=new n("link","Garage").render();e.append(i);const s=document.createElement("h1");return s.className="header__title",s.textContent="Async Race",t.append(s),e=document.createElement("a"),e.className="header__link",e.href="#winners",e.textContent="",t.append(e),i=new n("link","Winners").render(),e.append(i),e=document.createElement("a"),e.className="header__link",e.href="#help",e.textContent="",this.container.append(e),i=new n("link-help","?").render(),e.append(i),this.container}},document.body.append(this._header.render()),this._main=J.createContainer(),document.body.append(this._main),this._footer=new class{constructor(){this.container=document.createElement("footer"),this.container.className="footer-app"}render(){const t=document.createElement("div");t.className="footer__inner",this.container.append(t);let e=document.createElement("a");e.className="footer__link",e.href="https://github.com/ogimly",t.append(e);let n=document.createElement("div");return n.className="footer__github",n.textContent="2022",e.append(n),e=document.createElement("a"),e.className="footer__link",e.href="https://rs.school/js/",t.append(e),n=document.createElement("div"),n.className="footer__rss",e.append(n),this.container}},document.body.append(this._footer.render())}static createContainer(){const t=document.createElement("main");return t.className="main-app",t}mainRender(t){this._main.innerHTML="",this._main.append(t)}}const X=J;(new class{constructor(){const t=new class{constructor(){this._cars=[],this._carsNumber=0,this._carsPage=1,this._tracks={},this._controls=[],this._animations={},this.onChange=new D,this.onStartAnimation=new D,this.onStopAnimation=new D,this.onSetResultAnimation=new D}updView(){this.onChange.emit(this)}getCars(){return[...this._cars]}setCars(t){this._cars=[...t]}getCarsLength(){return this._cars.length}getCarsNumber(){return this._carsNumber}setCarsNumber(t){this._carsNumber=t}getCarsPage(){return this._carsPage}setCarsPage(t){this._carsPage=t}getCar(t){const e=this._cars.filter((e=>e.id===t));try{if(1===e.length)return e[0];throw Error(`Car id ${t} is not ${0===e.length?"found":"unique"} !`)}catch(t){r(t)}}setCar({id:t,name:e,color:n}){const i=this._cars.filter((e=>e.id===t));try{if(1!==i.length)throw Error(`Car id ${t} is not ${0===i.length?"found":"unique"} !`);i[0].name=e,i[0].color=n}catch(t){r(t)}}clearTracks(){this._tracks={},this._controls=[]}addTrack(t,e,n){this._tracks[t]=e,this._controls.push(n)}getTrackControls(){return[...this._controls]}getTrack(t){return Object.assign({},this._tracks[t])}getAnimation(t){return this._animations[t]?Object.assign({},this._animations[t]):{started:!1,time:0,startTime:0,track:{},requestID:0,result:""}}setIDAnimation(t,e){this._animations[t].requestID=e}setResultAnimation(t,e){this._animations[t]&&(this._animations[t].result=e,this.onSetResultAnimation.emit(t))}startAnimation(t,e,n,i){this._animations[t]={started:!0,time:e,startTime:i,track:n,requestID:0,result:""},this.onStartAnimation.emit(t)}stopAnimation(t){this._animations[t]&&(this._animations[t].started=!1,this._animations[t].time=0,this._animations[t].startTime=0,this._animations[t].track={},this.onStopAnimation.emit(t),this._animations[t].requestID=0)}},e=new class{constructor(){this._winners=[],this._winnersNumber=0,this._winnersPage=1,this._sort=p,this._order=g,this.onChange=new D}updView(){this.onChange.emit(this)}getSortName(){return this._sort}setSortName(t){this._sort=t}getSortOrder(){return this._order}setSortOrder(t){this._order=t}getWinners(){return[...this._winners]}setWinners(t){this._winners=[...t]}getWinnersNumber(){return this._winnersNumber}setWinnersNumber(t){this._winnersNumber=t}getWinnersPage(){return this._winnersPage}setWinnersPage(t){this._winnersPage=t}};this._view=new X;const n=new class{constructor(t,e=new $,n={}){this._state=t,this._racerService=e,this._paginationController=n,this._paginationController=new A(this._state,this)}getCars(){return k(this,void 0,void 0,(function*(){try{const t=yield this._racerService.getCars(this._state.getCarsPage());if(!(null==t?void 0:t.data)||!t.headers)throw new Error(`${o.noGetCars} ${o.noData}`);const e=t.data;this._state.setCars(e);const n=t.headers.get("X-Total-Count");if(!n)throw new Error(`${o.noGetCars} ${o.noData}`);this._state.setCarsNumber(+n),this._state.updView()}catch(t){}}))}addCar(t){return k(this,void 0,void 0,(function*(){try{yield this._racerService.createCar(t),7===this._state.getCarsLength()?this._paginationController.moveCarPage(Math.ceil((this._state.getCarsNumber()+1)/7)):yield this.getCars()}catch(t){r(t)}}))}addCars(){return k(this,void 0,void 0,(function*(){try{const t=[];for(let e=0;e<100;e++)t.push(this._racerService.createCar(N()));if(100!==(yield Promise.all(t)).filter((t=>t&&t.status===c.created)).length)throw new Error(`${o.noAddCar}`);this._paginationController.moveCarPage(Math.ceil((this._state.getCarsNumber()+100)/7))}catch(t){r(t)}}))}updateCar(t){return k(this,void 0,void 0,(function*(){try{yield this._racerService.updateCar(t.id,t),yield this.getCars()}catch(t){r(t)}}))}delCar(t){return k(this,void 0,void 0,(function*(){try{yield Promise.all([this._racerService.deleteCar(t.id),this._racerService.deleteWinner(t.id)]),1===this._state.getCarsLength()?this._paginationController.prevCarPage():yield this.getCars()}catch(t){r(t)}}))}}(t),i=new class{constructor(t,e=new $){this._state=t,this._racerService=e}getWinners(){return G(this,void 0,void 0,(function*(){try{const t=yield this._racerService.getWinners(this._state.getWinnersPage(),this._state.getSortName(),this._state.getSortOrder());if(!(null==t?void 0:t.data)||!t.headers)throw new Error(`${o.noGetWinners} ${o.noData}`);const e=t.data;this._state.setWinners(e);const n=t.headers.get("X-Total-Count");if(!n)throw new Error(`${o.noGetWinners} ${o.noData}`);this._state.setWinnersNumber(+n),this._state.updView()}catch(t){}}))}getCar(t){return G(this,void 0,void 0,(function*(){try{const e=yield this._racerService.getCar(t);return(null==e?void 0:e.status)!==c.notFound&&(null==e?void 0:e.data)}catch(t){r(t)}}))}}(e);this._routs={garage:new U(t,n,i),winners:new H(e,i),help:new O},this._router=new class{constructor(t,e){this._view=t,this._routs=e}run(){this.renderPage(this.getHash()),window.addEventListener("hashchange",(()=>{this.renderPage(this.getHash())}))}getHash(){return window.location.hash.slice(1)}renderPage(t){return function(t,e,n,i){return new(n||(n=Promise))((function(s,r){function a(t){try{c(i.next(t))}catch(t){r(t)}}function o(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,o)}c((i=i.apply(t,e||[])).next())}))}(this,void 0,void 0,(function*(){try{const e=this._routs[this._routs[t]?t:m];if(!e)throw new Error(`Page '${t}' is not defined!`);this._view.mainRender(e.getPage())}catch(t){r(t)}}))}}(this._view,this._routs)}start(){this._router.run()}}).start()})()})();